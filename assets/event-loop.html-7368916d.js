import{_ as t,a0 as p,a1 as e,a2 as n,a3 as s,a6 as o,a7 as c,a4 as l,C as i}from"./framework-16947f8e.js";const u={},k=n("h1",{id:"事件循环机制",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#事件循环机制","aria-hidden":"true"},"#"),s(" 事件循环机制")],-1),d=n("p",null,"在了解事件循环机制之前，需要了解：",-1),r=n("li",null,[n("p",null,"同步任务"),n("p",null,"在主线程上排队的任务，前一个任务执行完毕，才能继续执行下一个任务")],-1),v=n("p",null,"异步任务",-1),m=n("li",null,[n("p",null,"回调函数")],-1),b=n("li",null,[n("p",null,"js 在浏览器中的执行机制")],-1),y=l(`<h2 id="概述" tabindex="-1"><a class="header-anchor" href="#概述" aria-hidden="true">#</a> 概述</h2><p>事件循环机制是 html 提出的概念，是为了协调事件，用户交互，脚本，渲染，网络等，从整体上告诉了我们所写 JS 代码的执行顺序。</p><p>JS 的一大特点就是单线程，并没有专门的异步线程。但它也支持异步操作（暂时理解为又开了一个新的线程），这个异步操作是浏览器提供的，他会放到浏览器的循环队列里面，等待主线程栈发出命令来执行这个队列里面的事件。</p><p>在 JS 代码执行的过程中，通过函数的调用栈来决解函数的执行顺序，当然也存在另外一些特殊的状况，通过任务队列（task queue）来解决另外一些代码的执行。任务队列可以分为<code>宏任务(macro-task)</code>和<code>微任务(micro-task)</code></p><h2 id="异步任务" tabindex="-1"><a class="header-anchor" href="#异步任务" aria-hidden="true">#</a> 异步任务</h2><p>在上面提到了，异步任务是不会立马进入主线程的任务而是进入任务队列的任务，只有任务队列通知主线程，某个异步任务可以执行了，任务才会进入主线程执行。异步任务又可以分为：宏任务、微任务</p><h3 id="宏任务" tabindex="-1"><a class="header-anchor" href="#宏任务" aria-hidden="true">#</a> 宏任务</h3><p>宏任务就是所谓的主线程？</p><p>宏任务包含：script（整体代码）、setTimeout、setInterval、setImmediate、I/O、UI rendering</p><h3 id="微任务" tabindex="-1"><a class="header-anchor" href="#微任务" aria-hidden="true">#</a> 微任务</h3><p>微任务包含：process.nextTick、Promise、Object.observe</p><div class="hint-container warning"><p class="hint-container-title">注意</p><p>Promise 和 setTimeout 等还是同步的代码，称为任务源。而进入任务队列的是他们指定的具体所要执行的任务。Promise 具体需要执行的任务例如<code>then</code>函数是微任务，而 setTimeout 中携带的任务是宏任务。无论是微任务还是宏任务的执行，都需要借助<code>函数调用栈</code>（栈内存）来完成。</p><p>宏任务与微任务的执行顺序：先执行微任务，再执行宏任务</p></div><h3 id="_2023-4-8-更新" tabindex="-1"><a class="header-anchor" href="#_2023-4-8-更新" aria-hidden="true">#</a> 2023.4.8 更新</h3><p>面试题，下面输出的结果</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">asy1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">await</span> <span class="token function">asy2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">asy2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">await</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">asy3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">asy1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">asy3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>分析：</p><ol><li><p>执行函数<code>asy1</code>的同步代码</p></li><li><p>输出 7</p></li><li><p>执行函数<code>asy3</code>的同步代码</p></li></ol><p>细化上面的三点：</p><p>执行函数<code>asy1</code>的同步代码，<code>输出结果1</code>。</p><p>执行函数<code>asy2</code>的同步代码，0 秒后将计时器中的函数加入到宏任务队列。等待函数<code>asy2</code>的执行完成后，将<code>输出结果2</code>加入到微任务队列。虽然函数<code>asy2</code>中的同步代码执行完了，但是由于<code>await</code>关键字的存在，实际上是没有执行完的，还有一个<code>隐形的微任务</code>存在，所以此时<code>asy2</code>并没有执行完成。</p><p>相当于：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">asy2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">//隐形的.then</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果 7。</p><p>将输出 6 加入到微任务队列。</p><p>至此同步代码执行完成，执行微任务队列中的代码。</p><p>执行隐形的微任务，此时函数<code>asy2</code>执行完成，将输出结果<code>2</code>加入到微任务队列。</p><p><code>输出结果6</code></p><p><code>输出结果2</code></p><p>执行宏任务队列中的任务。将输出结果 3 加入到微任务队列</p><p>执行同步代码，<code>输出结果4</code></p><p>执行宏任务队列中的任务，<code>输出结果3</code></p><p>所以最终的输出结果为：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>1、7、6、2、4、3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_2023-4-28-更新" tabindex="-1"><a class="header-anchor" href="#_2023-4-28-更新" aria-hidden="true">#</a> 2023.4.28 更新</h3><p>工作中遇到一个问题：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> readline <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;readline&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> mydata<span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Outer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">await</span> <span class="token function">handleData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> new_res <span class="token operator">=</span> res <span class="token operator">?</span> res <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	new_res<span class="token punctuation">.</span>preEvalNumber <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token keyword">await</span> <span class="token function">updateData</span><span class="token punctuation">(</span>new_res<span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;mydata&quot;</span><span class="token punctuation">,</span> mydata<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> rl <span class="token operator">=</span> readline<span class="token punctuation">.</span><span class="token function">createInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
		<span class="token literal-property property">input</span><span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&quot;file.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	rl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;line&quot;</span><span class="token punctuation">,</span> <span class="token parameter">line</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		obj<span class="token punctuation">[</span>line<span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	rl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">await</span> <span class="token function">updateData</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">readData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> mydata<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">updateData</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		mydata <span class="token operator">=</span> data<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">Outer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果非常的不尽人意。。。。</p><p>预期：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>{
	a: &#39;a&#39;,
	b: &#39;b&#39;,
	c: &#39;c&#39;,
	preEvalNumber: 1
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果却是：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>{
	preEvalNumber: 1
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有点难受的，接着我就开始漫长的分析了。</p><p><strong>4.29:</strong></p><p>过了一天早上，我终于知道了！！！</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>rl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;line&quot;</span><span class="token punctuation">,</span> <span class="token parameter">line</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	obj<span class="token punctuation">[</span>line<span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">await</span> <span class="token function">updateData</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>看这一段代码，尝试着了解它的用意，这样子就很好理解了。</p><p>它其实就是一个读写文件的方法，而读写文件嘛，是需要时间的，所以为了防止阻塞，自然而然就设置成了异步的咯。</p><p>其实昨天困扰我的地方就是这个<code>close</code>事件，今天突然就醒悟了！读写文件是需要时间的呀，所以说这个<code>close</code>事件触发的时机，其实就是文件读写完成的时机。</p><p>难怪我昨天直接套了一层<code>setTimeout</code>时间写成 0 没有用呢，原来是这样的，我今天测试了一下，30 几行的文件需要至少 4ms 的时间，所以 setTimeout 的时间设置就成了关键。然后去百度了一下，大概一秒钟，也就是 1000ms，可以读写文件的大小为 70M 左右，所以我的解决方案：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> new_res <span class="token operator">=</span> res <span class="token operator">?</span> res <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	new_res<span class="token punctuation">.</span>preEvalNumber <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token keyword">await</span> <span class="token function">updateData</span><span class="token punctuation">(</span>new_res<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">const</span> latest_res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;latest_res&quot;</span><span class="token punctuation">,</span> latest_res<span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>mydata<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>5.27 更新</strong></p><p>今天在纠结 Promise 的时候，突然对上面的例子有了新的理解，所以就来更新一下。</p><p>在看红宝书的时候看到一句关于对 Promise 的描述：<code>支持优雅的定义和组织异步逻辑</code>。</p><p>虽然还在纠结 Promise 这玩意的意义，但是突然就联想到了上面的事例，有了新的解决方式。用 setTimeout 解决实在不够优雅，而且还不能确定这个时间。</p><p>其实可以这样子来处理 close 事件：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">handleData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> rl <span class="token operator">=</span> readline<span class="token punctuation">.</span><span class="token function">createInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			<span class="token literal-property property">input</span><span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&quot;file.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		rl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;line&quot;</span><span class="token punctuation">,</span> <span class="token parameter">line</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			obj<span class="token punctuation">[</span>line<span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		rl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">await</span> <span class="token function">updateData</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">resolve</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用 Promise 包裹这一段处理逻辑，核心是用到了 Promise 的 resolve 思想，等待 close 时间梳理完毕的时候，再将这个处理逻辑的状态改为完成，这样子就可以在外部使用 await 来等待这个处理逻辑的完成。</p><p>优雅，属实优雅，真的太优雅了。</p><p>但是关于 Promise 和异步编程，在我心里面还有有一小块疙瘩，总感觉使不上劲。。。</p><p>期待后面的一点点解决吧。</p><p><strong>5.30 更新</strong></p><p>解决了，终于解决了。出错的原因在前端传参数的时候传了一个空的 model_config，后端在这个地方的时候报错了：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">xxx</span> <span class="token punctuation">{</span>
	<span class="token comment">//验证中间模型</span>
	<span class="token function-variable function">evalMiddleModel</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>option<span class="token operator">:</span> CreatTrainQueue<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>funMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">EVAL_KEY</span><span class="token punctuation">,</span> EvalStatus<span class="token punctuation">.</span><span class="token constant">PAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;start eval middle model...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">const</span> TrainData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleMiddleModelOrEvalDataset</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">goEval</span><span class="token punctuation">(</span>TrainData <span class="token keyword">as</span> TrainData<span class="token punctuation">,</span> option<span class="token punctuation">.</span>model_path<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">return</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	handleMiddleModelOrEvalDataset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>model_id <span class="token operator">=</span> option<span class="token punctuation">.</span>model_id<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>model_type_id <span class="token operator">=</span> option<span class="token punctuation">.</span>model_type_id<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>model_path <span class="token operator">=</span> option<span class="token punctuation">.</span>model_path<span class="token punctuation">;</span>
		<span class="token keyword">const</span> evalOption <span class="token operator">=</span> <span class="token punctuation">{</span>
			evalType<span class="token operator">:</span> option<span class="token punctuation">.</span>model_config<span class="token punctuation">.</span>eval_type<span class="token punctuation">,</span><span class="token comment">//model_config为null，报错了</span>
			divide<span class="token operator">:</span> option<span class="token punctuation">.</span>model_config<span class="token punctuation">.</span>divide<span class="token punctuation">,</span>
			evalProject<span class="token operator">:</span> option<span class="token punctuation">.</span>model_config<span class="token punctuation">.</span>eval_project<span class="token punctuation">,</span>
			evalClass<span class="token operator">:</span> option<span class="token punctuation">.</span>model_config<span class="token punctuation">.</span>eval_classes<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">const</span> <span class="token punctuation">{</span> model_type_id<span class="token punctuation">,</span> model_path <span class="token punctuation">}</span> <span class="token operator">=</span> option<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>前端代码是这样的：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> model_config <span class="token operator">=</span> <span class="token keyword">typeof</span> modelInfo<span class="token punctuation">.</span>model_config <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>modelInfo<span class="token punctuation">.</span>model_config<span class="token punctuation">)</span> <span class="token operator">:</span> modelInfo<span class="token punctuation">.</span>model_config<span class="token punctuation">;</span>
<span class="token comment">// 查看测试结果</span>
<span class="token keyword">const</span> option<span class="token operator">:</span> PostData<span class="token punctuation">[</span><span class="token string">&quot;createTrainQueue&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>modelInfo<span class="token punctuation">,</span>
	model_id<span class="token operator">:</span> modelInfo<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
	sample_img_path<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
	task_type<span class="token operator">:</span> <span class="token string">&quot;continue&quot;</span><span class="token punctuation">,</span>
	model_config<span class="token operator">:</span> model_config<span class="token punctuation">,</span>
	sampleConfig<span class="token operator">:</span> model_config<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> stopResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">stopTrainQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//停止</span>
eventBus<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;getModelList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> needEval <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getMiddleModelNeedEval</span><span class="token punctuation">(</span><span class="token punctuation">{</span> model_id<span class="token operator">:</span> modelInfo<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;needEval&quot;</span><span class="token punctuation">,</span> needEval<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>needEval<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">setEvalLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">await</span> <span class="token function">evalModel</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">repeatGetEvalStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>今天把前面说的<code>appendFile</code>回调里面的<code>rl.on(&#39;close&#39;)</code>给删掉了，改成了同步的代码，就能够百分之百的复现了。</p><p>也就是在第一次走验证的时候会触发。是因为执行<code>evalType: option.model_config.eval_type</code>这里代码的时候报错了，然后我的trycatch在报错的时候又没有打印日志，所以造成了我的误解，我还一直以为是因为任务队列中返回的消息给函数执行打断了。</p><p>现在找到了为什么会报错，再来思考一下🤔为什么之前用异步的时候是偶然出现这个问题呢？</p><p>暂时不是很确定，明天再好好思考确认一下</p>`,69);function f(g,w){const a=i("RouterLink");return p(),e("div",null,[k,d,n("ul",null,[r,n("li",null,[v,n("p",null,[s("不会立马进入主线程，而是先进入任务队列的任务，只有任务队列通知主线程，某个异步任务可以执行了，任务才会进入主线程去执行。具体见"),o(a,{to:"/study/frontend/js/js-async.html"},{default:c(()=>[s("如何理解 JS 的异步")]),_:1})])]),m,b]),y])}const _=t(u,[["render",f],["__file","event-loop.html.vue"]]);export{_ as default};
