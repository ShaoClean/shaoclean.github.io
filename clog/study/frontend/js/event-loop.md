---
icon: javascript
date: 2022-09-19
star: 10
category:
    - å‰ç«¯
    - JS
tag:
    - äº‹ä»¶å¾ªç¯
    - å­¦ä¹ ç¬”è®°
---

# äº‹ä»¶å¾ªç¯æœºåˆ¶

åœ¨äº†è§£äº‹ä»¶å¾ªç¯æœºåˆ¶ä¹‹å‰ï¼Œéœ€è¦äº†è§£ï¼š

-   åŒæ­¥ä»»åŠ¡

    åœ¨ä¸»çº¿ç¨‹ä¸Šæ’é˜Ÿçš„ä»»åŠ¡ï¼Œå‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡

-   å¼‚æ­¥ä»»åŠ¡

    ä¸ä¼šç«‹é©¬è¿›å…¥ä¸»çº¿ç¨‹ï¼Œè€Œæ˜¯å…ˆè¿›å…¥ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œåªæœ‰ä»»åŠ¡é˜Ÿåˆ—é€šçŸ¥ä¸»çº¿ç¨‹ï¼ŒæŸä¸ªå¼‚æ­¥ä»»åŠ¡å¯ä»¥æ‰§è¡Œäº†ï¼Œä»»åŠ¡æ‰ä¼šè¿›å…¥ä¸»çº¿ç¨‹å»æ‰§è¡Œã€‚å…·ä½“è§[å¦‚ä½•ç†è§£ JS çš„å¼‚æ­¥](./js-async.html)

-   å›è°ƒå‡½æ•°

-   js åœ¨æµè§ˆå™¨ä¸­çš„æ‰§è¡Œæœºåˆ¶

## æ¦‚è¿°

äº‹ä»¶å¾ªç¯æœºåˆ¶æ˜¯ html æå‡ºçš„æ¦‚å¿µï¼Œæ˜¯ä¸ºäº†åè°ƒäº‹ä»¶ï¼Œç”¨æˆ·äº¤äº’ï¼Œè„šæœ¬ï¼Œæ¸²æŸ“ï¼Œç½‘ç»œç­‰ï¼Œä»æ•´ä½“ä¸Šå‘Šè¯‰äº†æˆ‘ä»¬æ‰€å†™ JS ä»£ç çš„æ‰§è¡Œé¡ºåºã€‚

JS çš„ä¸€å¤§ç‰¹ç‚¹å°±æ˜¯å•çº¿ç¨‹ï¼Œå¹¶æ²¡æœ‰ä¸“é—¨çš„å¼‚æ­¥çº¿ç¨‹ã€‚ä½†å®ƒä¹Ÿæ”¯æŒå¼‚æ­¥æ“ä½œï¼ˆæš‚æ—¶ç†è§£ä¸ºåˆå¼€äº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼‰ï¼Œè¿™ä¸ªå¼‚æ­¥æ“ä½œæ˜¯æµè§ˆå™¨æä¾›çš„ï¼Œä»–ä¼šæ”¾åˆ°æµè§ˆå™¨çš„å¾ªç¯é˜Ÿåˆ—é‡Œé¢ï¼Œç­‰å¾…ä¸»çº¿ç¨‹æ ˆå‘å‡ºå‘½ä»¤æ¥æ‰§è¡Œè¿™ä¸ªé˜Ÿåˆ—é‡Œé¢çš„äº‹ä»¶ã€‚

åœ¨ JS ä»£ç æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡å‡½æ•°çš„è°ƒç”¨æ ˆæ¥å†³è§£å‡½æ•°çš„æ‰§è¡Œé¡ºåºï¼Œå½“ç„¶ä¹Ÿå­˜åœ¨å¦å¤–ä¸€äº›ç‰¹æ®Šçš„çŠ¶å†µï¼Œé€šè¿‡ä»»åŠ¡é˜Ÿåˆ—ï¼ˆtask queueï¼‰æ¥è§£å†³å¦å¤–ä¸€äº›ä»£ç çš„æ‰§è¡Œã€‚ä»»åŠ¡é˜Ÿåˆ—å¯ä»¥åˆ†ä¸º`å®ä»»åŠ¡(macro-task)`å’Œ`å¾®ä»»åŠ¡(micro-task)`

## å¼‚æ­¥ä»»åŠ¡

åœ¨ä¸Šé¢æåˆ°äº†ï¼Œå¼‚æ­¥ä»»åŠ¡æ˜¯ä¸ä¼šç«‹é©¬è¿›å…¥ä¸»çº¿ç¨‹çš„ä»»åŠ¡è€Œæ˜¯è¿›å…¥ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œåªæœ‰ä»»åŠ¡é˜Ÿåˆ—é€šçŸ¥ä¸»çº¿ç¨‹ï¼ŒæŸä¸ªå¼‚æ­¥ä»»åŠ¡å¯ä»¥æ‰§è¡Œäº†ï¼Œä»»åŠ¡æ‰ä¼šè¿›å…¥ä¸»çº¿ç¨‹æ‰§è¡Œã€‚å¼‚æ­¥ä»»åŠ¡åˆå¯ä»¥åˆ†ä¸ºï¼šå®ä»»åŠ¡ã€å¾®ä»»åŠ¡

### å®ä»»åŠ¡

å®ä»»åŠ¡å°±æ˜¯æ‰€è°“çš„ä¸»çº¿ç¨‹ï¼Ÿ

å®ä»»åŠ¡åŒ…å«ï¼šscriptï¼ˆæ•´ä½“ä»£ç ï¼‰ã€setTimeoutã€setIntervalã€setImmediateã€I/Oã€UI rendering

### å¾®ä»»åŠ¡

å¾®ä»»åŠ¡åŒ…å«ï¼šprocess.nextTickã€Promiseã€Object.observe

:::warning æ³¨æ„

Promise å’Œ setTimeout ç­‰è¿˜æ˜¯åŒæ­¥çš„ä»£ç ï¼Œç§°ä¸ºä»»åŠ¡æºã€‚è€Œè¿›å…¥ä»»åŠ¡é˜Ÿåˆ—çš„æ˜¯ä»–ä»¬æŒ‡å®šçš„å…·ä½“æ‰€è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚Promise å…·ä½“éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ä¾‹å¦‚`then`å‡½æ•°æ˜¯å¾®ä»»åŠ¡ï¼Œè€Œ setTimeout ä¸­æºå¸¦çš„ä»»åŠ¡æ˜¯å®ä»»åŠ¡ã€‚æ— è®ºæ˜¯å¾®ä»»åŠ¡è¿˜æ˜¯å®ä»»åŠ¡çš„æ‰§è¡Œï¼Œéƒ½éœ€è¦å€ŸåŠ©`å‡½æ•°è°ƒç”¨æ ˆ`ï¼ˆæ ˆå†…å­˜ï¼‰æ¥å®Œæˆã€‚

å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºï¼šå…ˆæ‰§è¡Œå¾®ä»»åŠ¡ï¼Œå†æ‰§è¡Œå®ä»»åŠ¡

:::

### 2023.4.8 æ›´æ–°

é¢è¯•é¢˜ï¼Œä¸‹é¢è¾“å‡ºçš„ç»“æœ

```js
async function asy1() {
	console.log(1);
	await asy2();
	console.log(2);
}

async function asy2() {
	await setTimeout(_ => {
		Promise.resolve().then(_ => {
			console.log(3);
		});
		console.log(4);
	}, 0);
}

async function asy3() {
	Promise.resolve().then(_ => {
		console.log(6);
	});
}

asy1();
console.log(7);
asy3();
```

åˆ†æï¼š

1. æ‰§è¡Œå‡½æ•°`asy1`çš„åŒæ­¥ä»£ç 

2. è¾“å‡º 7

3. æ‰§è¡Œå‡½æ•°`asy3`çš„åŒæ­¥ä»£ç 

ç»†åŒ–ä¸Šé¢çš„ä¸‰ç‚¹ï¼š

æ‰§è¡Œå‡½æ•°`asy1`çš„åŒæ­¥ä»£ç ï¼Œ`è¾“å‡ºç»“æœ1`ã€‚

æ‰§è¡Œå‡½æ•°`asy2`çš„åŒæ­¥ä»£ç ï¼Œ0 ç§’åå°†è®¡æ—¶å™¨ä¸­çš„å‡½æ•°åŠ å…¥åˆ°å®ä»»åŠ¡é˜Ÿåˆ—ã€‚ç­‰å¾…å‡½æ•°`asy2`çš„æ‰§è¡Œå®Œæˆåï¼Œå°†`è¾“å‡ºç»“æœ2`åŠ å…¥åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚è™½ç„¶å‡½æ•°`asy2`ä¸­çš„åŒæ­¥ä»£ç æ‰§è¡Œå®Œäº†ï¼Œä½†æ˜¯ç”±äº`await`å…³é”®å­—çš„å­˜åœ¨ï¼Œå®é™…ä¸Šæ˜¯æ²¡æœ‰æ‰§è¡Œå®Œçš„ï¼Œè¿˜æœ‰ä¸€ä¸ª`éšå½¢çš„å¾®ä»»åŠ¡`å­˜åœ¨ï¼Œæ‰€ä»¥æ­¤æ—¶`asy2`å¹¶æ²¡æœ‰æ‰§è¡Œå®Œæˆã€‚

ç›¸å½“äºï¼š

```js
function asy2(){
  await new Promise((resolve)=>{
    let timer = setTimeout((_)=>{
        Promise.resolve().then((_)=>{
            console.log(3);
        })
        console.log(4);
    },0)
    resolve(timer);
  }).then((value)=>{
    //éšå½¢çš„.then
    //...
  })
}

```

è¾“å‡ºç»“æœ 7ã€‚

å°†è¾“å‡º 6 åŠ å…¥åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚

è‡³æ­¤åŒæ­¥ä»£ç æ‰§è¡Œå®Œæˆï¼Œæ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»£ç ã€‚

æ‰§è¡Œéšå½¢çš„å¾®ä»»åŠ¡ï¼Œæ­¤æ—¶å‡½æ•°`asy2`æ‰§è¡Œå®Œæˆï¼Œå°†è¾“å‡ºç»“æœ`2`åŠ å…¥åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚

`è¾“å‡ºç»“æœ6`

`è¾“å‡ºç»“æœ2`

æ‰§è¡Œå®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚å°†è¾“å‡ºç»“æœ 3 åŠ å…¥åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—

æ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œ`è¾“å‡ºç»“æœ4`

æ‰§è¡Œå®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œ`è¾“å‡ºç»“æœ3`

æ‰€ä»¥æœ€ç»ˆçš„è¾“å‡ºç»“æœä¸ºï¼š

```
1ã€7ã€6ã€2ã€4ã€3
```

### 2023.4.28 æ›´æ–°

å·¥ä½œä¸­é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼š

```js
const readline = require("readline");
const fs = require("fs");
let mydata;
async function Outer() {
	await handleData();

	const res = await readData();
	const new_res = res ? res : {};
	new_res.preEvalNumber = 1;

	await updateData(new_res);
	console.log("mydata", mydata);
}

async function handleData() {
	const rl = readline.createInterface({
		input: fs.createReadStream("file.txt"),
	});

	const obj = {};
	rl.on("line", line => {
		obj[line] = line;
	});

	rl.on("close", async () => {
		await updateData(arr);
	});
}

async function readData() {
	return mydata;
}

async function updateData(data) {
	await Promise.resolve().then(() => {
		mydata = data;
	});
}

Outer();
```

è¾“å‡ºç»“æœéå¸¸çš„ä¸å°½äººæ„ã€‚ã€‚ã€‚ã€‚

é¢„æœŸï¼š

```
{
	a: 'a',
	b: 'b',
	c: 'c',
	preEvalNumber: 1
}
```

ç»“æœå´æ˜¯ï¼š

```
{
	preEvalNumber: 1
}
```

æœ‰ç‚¹éš¾å—çš„ï¼Œæ¥ç€æˆ‘å°±å¼€å§‹æ¼«é•¿çš„åˆ†æäº†ã€‚

**4.29:**

è¿‡äº†ä¸€å¤©æ—©ä¸Šï¼Œæˆ‘ç»ˆäºçŸ¥é“äº†ï¼ï¼ï¼

```js
rl.on("line", line => {
	obj[line] = line;
});

rl.on("close", async () => {
	await updateData(arr);
});
```

çœ‹è¿™ä¸€æ®µä»£ç ï¼Œå°è¯•ç€äº†è§£å®ƒçš„ç”¨æ„ï¼Œè¿™æ ·å­å°±å¾ˆå¥½ç†è§£äº†ã€‚

å®ƒå…¶å®å°±æ˜¯ä¸€ä¸ªè¯»å†™æ–‡ä»¶çš„æ–¹æ³•ï¼Œè€Œè¯»å†™æ–‡ä»¶å˜›ï¼Œæ˜¯éœ€è¦æ—¶é—´çš„ï¼Œæ‰€ä»¥ä¸ºäº†é˜²æ­¢é˜»å¡ï¼Œè‡ªç„¶è€Œç„¶å°±è®¾ç½®æˆäº†å¼‚æ­¥çš„å’¯ã€‚

å…¶å®æ˜¨å¤©å›°æ‰°æˆ‘çš„åœ°æ–¹å°±æ˜¯è¿™ä¸ª`close`äº‹ä»¶ï¼Œä»Šå¤©çªç„¶å°±é†’æ‚Ÿäº†ï¼è¯»å†™æ–‡ä»¶æ˜¯éœ€è¦æ—¶é—´çš„å‘€ï¼Œæ‰€ä»¥è¯´è¿™ä¸ª`close`äº‹ä»¶è§¦å‘çš„æ—¶æœºï¼Œå…¶å®å°±æ˜¯æ–‡ä»¶è¯»å†™å®Œæˆçš„æ—¶æœºã€‚

éš¾æ€ªæˆ‘æ˜¨å¤©ç›´æ¥å¥—äº†ä¸€å±‚`setTimeout`æ—¶é—´å†™æˆ 0 æ²¡æœ‰ç”¨å‘¢ï¼ŒåŸæ¥æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä»Šå¤©æµ‹è¯•äº†ä¸€ä¸‹ï¼Œ30 å‡ è¡Œçš„æ–‡ä»¶éœ€è¦è‡³å°‘ 4ms çš„æ—¶é—´ï¼Œæ‰€ä»¥ setTimeout çš„æ—¶é—´è®¾ç½®å°±æˆäº†å…³é”®ã€‚ç„¶åå»ç™¾åº¦äº†ä¸€ä¸‹ï¼Œå¤§æ¦‚ä¸€ç§’é’Ÿï¼Œä¹Ÿå°±æ˜¯ 1000msï¼Œå¯ä»¥è¯»å†™æ–‡ä»¶çš„å¤§å°ä¸º 70M å·¦å³ï¼Œæ‰€ä»¥æˆ‘çš„è§£å†³æ–¹æ¡ˆï¼š

```js
setTimeout(async () => {
	const res = await readData();
	const new_res = res ? res : {};
	new_res.preEvalNumber = 1;

	await updateData(new_res);

	const latest_res = await readData();
	console.log("latest_res", latest_res);
	console.log(mydata);
}, 6);
```

**5.27 æ›´æ–°**

ä»Šå¤©åœ¨çº ç»“ Promise çš„æ—¶å€™ï¼Œçªç„¶å¯¹ä¸Šé¢çš„ä¾‹å­æœ‰äº†æ–°çš„ç†è§£ï¼Œæ‰€ä»¥å°±æ¥æ›´æ–°ä¸€ä¸‹ã€‚

åœ¨çœ‹çº¢å®ä¹¦çš„æ—¶å€™çœ‹åˆ°ä¸€å¥å…³äºå¯¹ Promise çš„æè¿°ï¼š`æ”¯æŒä¼˜é›…çš„å®šä¹‰å’Œç»„ç»‡å¼‚æ­¥é€»è¾‘`ã€‚

è™½ç„¶è¿˜åœ¨çº ç»“ Promise è¿™ç©æ„çš„æ„ä¹‰ï¼Œä½†æ˜¯çªç„¶å°±è”æƒ³åˆ°äº†ä¸Šé¢çš„äº‹ä¾‹ï¼Œæœ‰äº†æ–°çš„è§£å†³æ–¹å¼ã€‚ç”¨ setTimeout è§£å†³å®åœ¨ä¸å¤Ÿä¼˜é›…ï¼Œè€Œä¸”è¿˜ä¸èƒ½ç¡®å®šè¿™ä¸ªæ—¶é—´ã€‚

å…¶å®å¯ä»¥è¿™æ ·å­æ¥å¤„ç† close äº‹ä»¶ï¼š

```js
function handleData() {
	return new Promise((resolve, reject) => {
		const rl = readline.createInterface({
			input: fs.createReadStream("file.txt"),
		});

		const obj = {};
		rl.on("line", line => {
			obj[line] = line;
		});

		rl.on("close", async () => {
			await updateData(obj);
			resolve(obj);
		});
	});
}
```

ç”¨ Promise åŒ…è£¹è¿™ä¸€æ®µå¤„ç†é€»è¾‘ï¼Œæ ¸å¿ƒæ˜¯ç”¨åˆ°äº† Promise çš„ resolve æ€æƒ³ï¼Œç­‰å¾… close æ—¶é—´æ¢³ç†å®Œæ¯•çš„æ—¶å€™ï¼Œå†å°†è¿™ä¸ªå¤„ç†é€»è¾‘çš„çŠ¶æ€æ”¹ä¸ºå®Œæˆï¼Œè¿™æ ·å­å°±å¯ä»¥åœ¨å¤–éƒ¨ä½¿ç”¨ await æ¥ç­‰å¾…è¿™ä¸ªå¤„ç†é€»è¾‘çš„å®Œæˆã€‚

ä¼˜é›…ï¼Œå±å®ä¼˜é›…ï¼ŒçœŸçš„å¤ªä¼˜é›…äº†ã€‚

ä½†æ˜¯å…³äº Promise å’Œå¼‚æ­¥ç¼–ç¨‹ï¼Œåœ¨æˆ‘å¿ƒé‡Œé¢è¿˜æœ‰æœ‰ä¸€å°å—ç–™ç˜©ï¼Œæ€»æ„Ÿè§‰ä½¿ä¸ä¸ŠåŠ²ã€‚ã€‚ã€‚

æœŸå¾…åé¢çš„ä¸€ç‚¹ç‚¹è§£å†³å§ã€‚

**5.30 æ›´æ–°**

è§£å†³äº†ï¼Œç»ˆäºè§£å†³äº†ã€‚å‡ºé”™çš„åŸå› åœ¨å‰ç«¯ä¼ å‚æ•°çš„æ—¶å€™ä¼ äº†ä¸€ä¸ªç©ºçš„ model_configï¼Œåç«¯åœ¨è¿™ä¸ªåœ°æ–¹çš„æ—¶å€™æŠ¥é”™äº†ï¼š

```ts
class xxx {
	//éªŒè¯ä¸­é—´æ¨¡å‹
	evalMiddleModel = async (option: CreatTrainQueue) => {
		try {
			this.funMap.set(this.EVAL_KEY, EvalStatus.PAD);
			console.log("start eval middle model...");
			const TrainData = await this.handleMiddleModelOrEvalDataset(option);

			await this.goEval(TrainData as TrainData, option.model_path);

			return { status: true };
		} catch (e) {
			return { status: false };
		}
	};

	handleMiddleModelOrEvalDataset = (){
		this.model_id = option.model_id;
		this.model_type_id = option.model_type_id;
		this.model_path = option.model_path;
		const evalOption = {
			evalType: option.model_config.eval_type,//model_configä¸ºnullï¼ŒæŠ¥é”™äº†
			divide: option.model_config.divide,
			evalProject: option.model_config.eval_project,
			evalClass: option.model_config.eval_classes,
		}
		const { model_type_id, model_path } = option;
	}
}
```

å‰ç«¯ä»£ç æ˜¯è¿™æ ·çš„ï¼š

```ts
const model_config = typeof modelInfo.model_config === "string" ? JSON.parse(modelInfo.model_config) : modelInfo.model_config;
// æŸ¥çœ‹æµ‹è¯•ç»“æœ
const option: PostData["createTrainQueue"] = {
	...modelInfo,
	model_id: modelInfo.id,
	sample_img_path: "",
	task_type: "continue",
	model_config: model_config,
	sampleConfig: model_config,
};

const stopResult = await stopTrainQueue(); //åœæ­¢
eventBus.emit("getModelList");
const needEval = await getMiddleModelNeedEval({ model_id: modelInfo.id });
console.log("needEval", needEval);
if (needEval.status) {
	setEvalLoading(true);
	await evalModel(option);
	repeatGetEvalStatus();
	return;
}
```

ä»Šå¤©æŠŠå‰é¢è¯´çš„`appendFile`å›è°ƒé‡Œé¢çš„`rl.on('close')`ç»™åˆ æ‰äº†ï¼Œæ”¹æˆäº†åŒæ­¥çš„ä»£ç ï¼Œå°±èƒ½å¤Ÿç™¾åˆ†ä¹‹ç™¾çš„å¤ç°äº†ã€‚

ä¹Ÿå°±æ˜¯åœ¨ç¬¬ä¸€æ¬¡èµ°éªŒè¯çš„æ—¶å€™ä¼šè§¦å‘ã€‚æ˜¯å› ä¸ºæ‰§è¡Œ`evalType: option.model_config.eval_type`è¿™é‡Œä»£ç çš„æ—¶å€™æŠ¥é”™äº†ï¼Œç„¶åæˆ‘çš„trycatchåœ¨æŠ¥é”™çš„æ—¶å€™åˆæ²¡æœ‰æ‰“å°æ—¥å¿—ï¼Œæ‰€ä»¥é€ æˆäº†æˆ‘çš„è¯¯è§£ï¼Œæˆ‘è¿˜ä¸€ç›´ä»¥ä¸ºæ˜¯å› ä¸ºä»»åŠ¡é˜Ÿåˆ—ä¸­è¿”å›çš„æ¶ˆæ¯ç»™å‡½æ•°æ‰§è¡Œæ‰“æ–­äº†ã€‚

ç°åœ¨æ‰¾åˆ°äº†ä¸ºä»€ä¹ˆä¼šæŠ¥é”™ï¼Œå†æ¥æ€è€ƒä¸€ä¸‹ğŸ¤”ä¸ºä»€ä¹ˆä¹‹å‰ç”¨å¼‚æ­¥çš„æ—¶å€™æ˜¯å¶ç„¶å‡ºç°è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ

æš‚æ—¶ä¸æ˜¯å¾ˆç¡®å®šï¼Œæ˜å¤©å†å¥½å¥½æ€è€ƒç¡®è®¤ä¸€ä¸‹